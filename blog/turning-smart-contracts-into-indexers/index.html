<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Turning Smart Contracts into Indexers | Aurora Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doc.aurora.dev/blog/turning-smart-contracts-into-indexers"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Turning Smart Contracts into Indexers | Aurora Documentation"><meta data-rh="true" name="description" content="Learn how you can use functional programming patterns in Rust to share a codebase between both a smart contract and an indexer, and how cross-compilation can benefit your project"><meta data-rh="true" property="og:description" content="Learn how you can use functional programming patterns in Rust to share a codebase between both a smart contract and an indexer, and how cross-compilation can benefit your project"><meta data-rh="true" property="og:image" content="https://www.datocms-assets.com/95026/1692963087-tsci.png"><meta data-rh="true" name="twitter:image" content="https://www.datocms-assets.com/95026/1692963087-tsci.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-08-25T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="Tutorials"><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://doc.aurora.dev/blog/turning-smart-contracts-into-indexers"><link data-rh="true" rel="alternate" href="https://doc.aurora.dev/blog/turning-smart-contracts-into-indexers" hreflang="en"><link data-rh="true" rel="alternate" href="https://doc.aurora.dev/blog/turning-smart-contracts-into-indexers" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://BEGR6ON9SL-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://doc.aurora.dev/blog/turning-smart-contracts-into-indexers","mainEntityOfPage":"https://doc.aurora.dev/blog/turning-smart-contracts-into-indexers","url":"https://doc.aurora.dev/blog/turning-smart-contracts-into-indexers","headline":"Turning Smart Contracts into Indexers","name":"Turning Smart Contracts into Indexers","description":"Learn how you can use functional programming patterns in Rust to share a codebase between both a smart contract and an indexer, and how cross-compilation can benefit your project","datePublished":"2023-08-25T00:00:00.000Z","author":{"@type":"Person","name":"Michael Birch","description":"Senior Research Engineer","image":"https://www.datocms-assets.com/95026/1683043123-t025c6kc9px-u025f7t5npl-c56792be0091-512.jpeg"},"image":{"@type":"ImageObject","@id":"https://www.datocms-assets.com/95026/1692963087-tsci.png","url":"https://www.datocms-assets.com/95026/1692963087-tsci.png","contentUrl":"https://www.datocms-assets.com/95026/1692963087-tsci.png","caption":"title image for the blog post: Turning Smart Contracts into Indexers"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://doc.aurora.dev/blog","name":"Aurora Dev Portal"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Aurora Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Aurora Documentation Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="Aurora Documentation JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-MX4G4L5"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-MX4G4L5",{anonymize_ip:!0})</script>



<link rel="search" type="application/opensearchdescription+xml" title="Aurora Documentation" href="/opensearch.xml">




<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono:400,500,700|IBM+Plex+Sans:400,500,700"><link rel="stylesheet" href="/assets/css/styles.bbad4119.css">
<script src="/assets/js/runtime~main.dd68d6d6.js" defer="defer"></script>
<script src="/assets/js/main.4792eac5.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fh7N" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/docs_logo.svg" alt="Aurora logo" class="themedComponent_zcmF themedComponent--light_PZnH"><img src="/img/docs_logo_white.svg" alt="Aurora logo" class="themedComponent_zcmF themedComponent--dark_g7nS"></div></a><a class="navbar__item navbar__link" href="/">Learn</a><a class="navbar__item navbar__link" href="/build-a-dapp/introduction">Build on Aurora</a><a class="navbar__item navbar__link" href="/aurora-cloud/welcome/introduction">Launch a Virtual Chain</a><a class="navbar__item navbar__link" href="/dev-tools/quickstart">Dev tools</a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Resources</a><ul class="dropdown__menu"><li><a href="https://github.com/aurora-is-near/doc.aurora.dev" target="_blank" rel="noopener noreferrer" class="dropdown__link">GitHub<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_Tdoh"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://discord.gg/RQetTRnMrC" target="_blank" rel="noopener noreferrer" class="dropdown__link">Discord<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_Tdoh"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="toggle_fulQ colorModeToggle_ImEy"><button class="clean-btn toggleButton_Lj21 toggleButtonDisabled__aCk" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_OLJl"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_yGhH"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_sH4B"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_pvXw"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_pQfw thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_Bfav margin-bottom--md">All our posts</div><div role="group"><h3 class="yearGroupHeading_Xod9">2025</h3><ul class="sidebarItemList_zV4q clean-list"><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/safe-bitcoin-demo">Safe Wallet and Aurora: multisigs for Bitcoin</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_Xod9">2024</h3><ul class="sidebarItemList_zV4q clean-list"><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/how-to-bridge-liquidity-to-aurora">How to bridge liquidity to Aurora?</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/hot-to-get-your-tokens-from-bastion-contract">How to get your tokens from Bastion contracts?</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/managing-aurora-s-validator-staking-with-near-cli-rs">Managing Aurora&#x27;s Validator staking with &#x27;near-cli-rs&#x27;</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/plugins-for-smart-contract-devs-building-on-near">Plugins for smart contract devs building on Near</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_Xod9">2023</h3><ul class="sidebarItemList_zV4q clean-list"><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/contract-callbacks-in-xcc">Contract Callbacks in XCC</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/practical-erc20-burning">Practical ERC20 Burning</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/communication-from-aurora-to-near-local-testing">Integration tests for XCC communication</a></li><li class="sidebarItem_wfWn"><a aria-current="page" class="sidebarItemLink_VSNE sidebarItemLinkActive_eI13" href="/blog/turning-smart-contracts-into-indexers">Turning Smart Contracts into Indexers</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/how-to-get-usdc-tokens-on-aurora-testnet">How to get USDC tokens on Aurora testnet</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/evm-gas-near-gas-on-aurora">EVM gas vs. Near gas on Aurora</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/aurora-cloud-borealis-business">Aurora Cloud: Borealis Business</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/getting-started-with-aurora">Getting started with Aurora</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/spinning-up-your-own-aurora-node">Spinning up your own Aurora node</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/aurora-chains-code-overview">Aurora Chains: Code Overview</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/building-a-game-using-near-aurora-and-bos">Building a game using Near, Aurora and BOS</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/aurora-chains-demo">Aurora Chains: Walkthrough</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/cross-ecosystem-communication">Cross-Ecosystem Communication</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/aurora-relayer-2-0">How the Aurora Relayer 2.0 works?</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/convert-aurora-transaction-into-near-s-one">How to get NEAR transaction from the Aurora’s one?</a></li><li class="sidebarItem_wfWn"><a class="sidebarItemLink_VSNE" href="/blog/demystifying-transaction-failures">Demystifying Transaction Failures</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_zhlg">Turning Smart Contracts into Indexers</h1><div class="container_bHeg margin-vert--md"><time datetime="2023-08-25T00:00:00.000Z">August 25, 2023</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_PhGv"><div class="avatar margin-bottom--sm"><img class="avatar__photo authorImage_akNC" src="https://www.datocms-assets.com/95026/1683043123-t025c6kc9px-u025f7t5npl-c56792be0091-512.jpeg" alt="Michael Birch"><div class="avatar__intro authorDetails_qowP"><div class="avatar__name"><span class="authorName_GYtA">Michael Birch</span></div><small class="authorTitle_PiOF" title="Senior Research Engineer">Senior Research Engineer</small><div class="authorSocials_Z9RR"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Recently, Michael Birch gave a <a href="https://www.conf42.com/Rustlang_2023_Michael_Birch_smart_contracts_indexers_crosscompilation" target="_blank" rel="noopener noreferrer"><em>talk at a virtual Rust conference</em></a> about some work we have done here at Aurora to enable our technology. In case you missed it, this blog post is a written version of the talk.</p>
<p>That talk was aimed at a more general audience, giving background about Aurora, Near, and blockchain technology in general. However, this post assumes you are already familiar with most of the Aurora/Near/blockchain background (you are here on our website, after all) and instead focuses more on the Rust side of things.</p>
<h2 class="anchor anchorWithStickyNavbar_L_jL" id="motivation">Motivation<a href="#motivation" class="hash-link" aria-label="Direct link to Motivation" title="Direct link to Motivation">​</a></h2>
<p>The goal of this post is to describe how you can use functional programming patterns in Rust to share a codebase between both a smart contract and an indexer. But the first question to answer is why this is desirable in the first place.</p>
<p>Indexers provide a specialized view of the blockchain state to enable low-latency responses to particular kinds of queries. For example, block explorers will use an indexer to show the balances of all the tokens held by a user. An indexer is required to accomplish this because the on-chain information about balances is indexed in the opposite way to how the block explorer displays the information. By which I mean that on-chain each token has information about all the addresses with a non-zero balance, but the block explorer shows all the non-zero balances for a single address.</p>
<p>Generally, indexers are specialized to follow the state of a particular contract (or class of contracts). Therefore, the code for the indexer is closely related to the code for the smart contract it follows. Thus, it would be lower developer maintenance to have a common codebase for the smart contract and its associated indexer.</p>
<p>Additionally, sharing a codebase makes it possible to create much more powerful indexers than simply something that can respond to queries. For example, an indexer with access to the smart contract logic can simulate whole transactions off-chain to provide free and low-latency feedback to users on potential errors.</p>
<p>In the case of Aurora, the indexer we use for the Aurora Engine smart contract serves data that is used by <a href="/blog/spinning-up-your-own-aurora-node">our RPC implementation.</a> The Ethereum RPC spec includes a few methods (e.g., <code>eth_estimateGas</code>) which require simulating transactions before submitting them to the chain. Therefore, we have a clear use for the extra indexer features that are enabled by having a shared codebase between the Aurora Engine and its indexer.</p>
<h2 class="anchor anchorWithStickyNavbar_L_jL" id="rust-features">Rust Features<a href="#rust-features" class="hash-link" aria-label="Direct link to Rust Features" title="Direct link to Rust Features">​</a></h2>
<p>To reach the goal of having a shared codebase between the Aurora Engine and an indexer for the Engine, we leverage some features of Rust.</p>
<h3 class="anchor anchorWithStickyNavbar_L_jL" id="cross-compilation">Cross-Compilation<a href="#cross-compilation" class="hash-link" aria-label="Direct link to Cross-Compilation" title="Direct link to Cross-Compilation">​</a></h3>
<p>The Aurora Engine is written in Rust because it is a smart contract on Near which uses Web Assembly as its runtime. Rust has good support for Web Assembly (Wasm) as a compilation target, so it is a good language choice for writing smart contracts for Near. But, of course, it also is able to compile the same code to executable binaries for typical platforms (e.g., Linux). Compiling the same code to multiple output targets is referred to as “cross-compiling”.</p>
<p>The first step to having our smart contract code also be used as an indexer is to cross-compile the same code as both Wasm and a native executable. In Rust, it is easy to install other compilation targets (the default target will be whatever platform you installed Rust on) and to specify them as the compilation target. The following commands show installing the Wasm target and compiling a project to Wasm.</p>
<div class="language-shell codeBlockContainer_N8ub theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aLV6"><pre tabindex="0" class="prism-code language-shell codeBlock_hirX thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_WzCr"><span class="token-line" style="color:#393A34"><span class="token plain">$ rustup target add wasm32-unknown-unknown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cargo build --release –-target wasm32-unknown-unknown</span><br></span></code></pre><div class="buttonGroup_YzQc"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_JSbB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ilDU"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pqXq"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_L_jL" id="conditional-compilation">Conditional Compilation<a href="#conditional-compilation" class="hash-link" aria-label="Direct link to Conditional Compilation" title="Direct link to Conditional Compilation">​</a></h3>
<p>When you start compiling code to multiple platforms, likely there will be situations where you want the implementation to differ depending on the compilation target. For example, native code can read from a local file system, whereas Wasm modules need to delegate to their host (the machine running the Wasm VM) to access state.</p>
<p>In Rust, you can use conditional compilation to have different implementations depending on the target. In the example below, the function `foo` has different implementations depending on if the compilation target is Wasm or not.</p>
<div class="language-rust codeBlockContainer_N8ub theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aLV6"><pre tabindex="0" class="prism-code language-rust codeBlock_hirX thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_WzCr"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">foo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute attr-name" style="color:#00a4db">#[cfg(target_arch = </span><span class="token attribute attr-name string" style="color:#e3116c">&quot;wasm32&quot;</span><span class="token attribute attr-name" style="color:#00a4db">)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">foo_for_wasm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute attr-name" style="color:#00a4db">#[cfg(not(target_arch = </span><span class="token attribute attr-name string" style="color:#e3116c">&quot;wasm32&quot;</span><span class="token attribute attr-name" style="color:#00a4db">))]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">foo_for_generic_arch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_YzQc"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_JSbB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ilDU"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pqXq"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>However, conditional compilation has some drawbacks. First of all, it’s a little verbose, which hurts code readability. You can see in the example above that the function <code>foo</code> is “noisier” than it would be if not for the extra conditional compilation annotations. Secondly, IDEs do not handle conditional compilation especially well. They will only analyze one branch of the code at a time, and it is a little tedious to switch between which target you are asking the IDE to check.</p>
<p>Fortunately, we do not need to use conditional compilation very much because we can adopt coding style patterns from functional programming. The key idea is to write code that is abstract with respect to the implementation of target-specific effects such as reading/writing state. In Rust, we can accomplish this using traits and type generics.</p>
<h3 class="anchor anchorWithStickyNavbar_L_jL" id="traits-and-type-generics">Traits and Type Generics<a href="#traits-and-type-generics" class="hash-link" aria-label="Direct link to Traits and Type Generics" title="Direct link to Traits and Type Generics">​</a></h3>
<p>Rust’s trait defines an interface. It gives the type signatures of the methods a type implementing that trait must have, but does not necessarily specify the implementation of those methods (though you are allowed to give a default implementation of a method in a trait). Consider the following example:</p>
<div class="language-rust codeBlockContainer_N8ub theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aLV6"><pre tabindex="0" class="prism-code language-rust codeBlock_hirX thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_WzCr"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> </span><span class="token type-definition class-name">IO</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">get_balance</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IO</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">io</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">User</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u128</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">u128</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from_be_bytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">r</span><br></span></code></pre><div class="buttonGroup_YzQc"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_JSbB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ilDU"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pqXq"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This example includes a trait with a (simplified) interface for interacting with state as well as a function with a generic type parameter. The syntax means “this function accepts any type so long as it implements <code>IO</code> the interface”. The benefit of coding in this style is that the <code>get_balance</code> function can now be reused in any program, regardless of what compilation target it uses, so long as there is an <code>IO</code> implementation for it. This is exactly what enables us to share a codebase between our smart contract and indexer.</p>
<p>In this example above, it might seem like we are going through a lot of trouble to reuse one line of code in two different places. But this approach scales. The function we share does not need to be only a single line, it could have any amount of complexity.</p>
<p>Moreover, state access is not the only target-specific effect. We can have traits for accessing environment variables (in the blockchain context, these would be variables like the current block height, the signer of the transaction, etc) and interacting with other processes (in the blockchain context, this corresponds to calling other smart contracts).</p>
<p>Beyond reusability, there are other benefits to coding in this style. Code written in this way is easier to test because you can simulate the effects in-memory (for example, instead of actually reading and writing files). It is also easier to reason about this style of code. When there are no side-effects, the function signature gives you all the information you need about the function.</p>
<p>If a function needs access to state, then you know it will include the <code>IO</code> trait bound, and conversely, if the state is not needed, then it will not include that bound. When you can learn so much about a function without reading its implementation body, it becomes much easier to navigate the codebase.</p>
<h2 class="anchor anchorWithStickyNavbar_L_jL" id="application-aurora-engine">Application: Aurora Engine<a href="#application-aurora-engine" class="hash-link" aria-label="Direct link to Application: Aurora Engine" title="Direct link to Application: Aurora Engine">​</a></h2>
<p>The entire Aurora Engine is written in this style. For example, <a href="https://github.com/aurora-is-near/aurora-engine/blob/2.10.2/engine/src/engine.rs#L1280" target="_blank" rel="noopener noreferrer"><em>here</em></a> is the real version of the <code>get_balance</code> function we showed a toy example of above. And similarly, there is a <code>set_balance</code> <a href="https://github.com/aurora-is-near/aurora-engine/blob/2.10.2/engine/src/engine.rs#L1269" target="_blank" rel="noopener noreferrer"><em>function</em></a>. These two functions are composed together to make an <code>add_balance</code> <a href="https://github.com/aurora-is-near/aurora-engine/blob/2.10.2/engine/src/engine.rs#L1258" target="_blank" rel="noopener noreferrer"><em>function</em></a>.</p>
<div class="language-rust codeBlockContainer_N8ub theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aLV6"><pre tabindex="0" class="prism-code language-rust codeBlock_hirX thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_WzCr"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">get_balance</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IO</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">io</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">Address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Wei</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> raw </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">read_u256</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token function" style="color:#d73a49">address_to_key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">KeyPrefix</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unwrap_or_else</span><span class="token punctuation" style="color:#393A34">(</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">_</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">U256</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Wei</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">raw</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">set_balance</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IO</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">io</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">Address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> balance</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">Wei</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">write_storage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token function" style="color:#d73a49">address_to_key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">KeyPrefix</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">balance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">to_bytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">add_balance</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IO</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    io</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">Address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    amount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Wei</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">BalanceOverflow</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> current_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_balance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">io</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> new_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> current_balance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">checked_add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">amount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ok_or</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BalanceOverflow</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">set_balance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">io</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">new_balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_YzQc"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_JSbB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ilDU"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_pqXq"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can see the implementation of the <code>IO</code> trait for both the <a href="https://github.com/aurora-is-near/aurora-engine/blob/2.10.2/engine-sdk/src/near_runtime.rs#L128" target="_blank" rel="noopener noreferrer"><em>Near Runtime</em></a>, and the “<a href="https://github.com/aurora-is-near/aurora-engine/blob/2.10.2/engine-standalone-storage/src/engine_state.rs#L82" target="_blank" rel="noopener noreferrer"><em>standalone engine</em></a>” which uses a <code>rocksdb</code> instance to persist the state.</p>
<p>The former is used in the Wasm artifact, which is deployed to Near as the Aurora Engine smart contract. The standalone engine is used to <a href="https://github.com/aurora-is-near/borealis-engine-lib/blob/v0.23.4/refiner-app/src/socket.rs#L129" target="_blank" rel="noopener noreferrer"><em>implement the eth_estimateGas RPC method</em></a>, and the state is populated by <a href="https://github.com/aurora-is-near/aurora-engine/blob/2.10.2/engine-standalone-storage/src/sync/mod.rs#L229" target="_blank" rel="noopener noreferrer"><em>consuming Near blocks</em></a> (from <a href="https://github.com/aurora-is-near/borealis-engine-lib/tree/v0.23.4#near-data-lake" target="_blank" rel="noopener noreferrer"><em>Near data lake for example</em></a>).</p>
<h2 class="anchor anchorWithStickyNavbar_L_jL" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>The take-home message from this post is that following the functional programming pattern of only writing business logic using abstractions of target-specific effects such as IO results in code that is easier to test, maintain, and reuse. In the particular case of Aurora, that reuse manifests as having the Aurora Engine smart contract and the indexer that serves the Aurora RPC share a codebase.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_h0Ok padding--none margin-left--sm"><li class="tag_aRsb"><a title="Longer posts talking about the subject in detail" class="tag_r0gA tagRegular_xFZp" href="/blog/tags/tutorials">Tutorials</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/aurora-is-near/doc.aurora.dev/edit/master/blog/turning-smart-contracts-into-indexers.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_tJlD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_z36Z"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/communication-from-aurora-to-near-local-testing"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Integration tests for XCC communication</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/how-to-get-usdc-tokens-on-aurora-testnet"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">How to get USDC tokens on Aurora testnet</div></a></nav></main><div class="col col--2"><div class="tableOfContents_HSkM thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#motivation" class="table-of-contents__link toc-highlight">Motivation</a></li><li><a href="#rust-features" class="table-of-contents__link toc-highlight">Rust Features</a><ul><li><a href="#cross-compilation" class="table-of-contents__link toc-highlight">Cross-Compilation</a></li><li><a href="#conditional-compilation" class="table-of-contents__link toc-highlight">Conditional Compilation</a></li><li><a href="#traits-and-type-generics" class="table-of-contents__link toc-highlight">Traits and Type Generics</a></li></ul></li><li><a href="#application-aurora-engine" class="table-of-contents__link toc-highlight">Application: Aurora Engine</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="col footer__col"><ul class="footer__items is-custom-links"><li class="footer__item"><a href="https://github.com/aurora-is-near" target="_blank" rel="nofollow noopener noreferrer" class="footer__link-item" title="Aurora on GitHub"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-lg" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li><li class="footer__item"><a href="https://forum.aurora.dev/" target="_blank" rel="nofollow noopener noreferrer" class="footer__link-item" title="Aurora on Discourse"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="discourse" class="svg-inline--fa fa-discourse fa-lg" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M225.9 32C103.3 32 0 130.5 0 252.1 0 256 .1 480 .1 480l225.8-.2c122.7 0 222.1-102.3 222.1-223.9C448 134.3 348.6 32 225.9 32zM224 384c-19.4 0-37.9-4.3-54.4-12.1L88.5 392l22.9-75c-9.8-18.1-15.4-38.9-15.4-61 0-70.7 57.3-128 128-128s128 57.3 128 128-57.3 128-128 128z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/auroralabs" target="_blank" rel="nofollow noopener noreferrer" class="footer__link-item" title="Aurora on Discord"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="discord" class="svg-inline--fa fa-discord fa-lg" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M524.531,69.836a1.5,1.5,0,0,0-.764-.7A485.065,485.065,0,0,0,404.081,32.03a1.816,1.816,0,0,0-1.923.91,337.461,337.461,0,0,0-14.9,30.6,447.848,447.848,0,0,0-134.426,0,309.541,309.541,0,0,0-15.135-30.6,1.89,1.89,0,0,0-1.924-.91A483.689,483.689,0,0,0,116.085,69.137a1.712,1.712,0,0,0-.788.676C39.068,183.651,18.186,294.69,28.43,404.354a2.016,2.016,0,0,0,.765,1.375A487.666,487.666,0,0,0,176.02,479.918a1.9,1.9,0,0,0,2.063-.676A348.2,348.2,0,0,0,208.12,430.4a1.86,1.86,0,0,0-1.019-2.588,321.173,321.173,0,0,1-45.868-21.853,1.885,1.885,0,0,1-.185-3.126c3.082-2.309,6.166-4.711,9.109-7.137a1.819,1.819,0,0,1,1.9-.256c96.229,43.917,200.41,43.917,295.5,0a1.812,1.812,0,0,1,1.924.233c2.944,2.426,6.027,4.851,9.132,7.16a1.884,1.884,0,0,1-.162,3.126,301.407,301.407,0,0,1-45.89,21.83,1.875,1.875,0,0,0-1,2.611,391.055,391.055,0,0,0,30.014,48.815,1.864,1.864,0,0,0,2.063.7A486.048,486.048,0,0,0,610.7,405.729a1.882,1.882,0,0,0,.765-1.352C623.729,277.594,590.933,167.465,524.531,69.836ZM222.491,337.58c-28.972,0-52.844-26.587-52.844-59.239S193.056,219.1,222.491,219.1c29.665,0,53.306,26.82,52.843,59.239C275.334,310.993,251.924,337.58,222.491,337.58Zm195.38,0c-28.971,0-52.843-26.587-52.843-59.239S388.437,219.1,417.871,219.1c29.667,0,53.307,26.82,52.844,59.239C470.715,310.993,447.538,337.58,417.871,337.58Z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/auroraisnear" target="_blank" rel="nofollow noopener noreferrer" class="footer__link-item" title="Aurora on Telegram"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="telegram" class="svg-inline--fa fa-telegram fa-lg" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M248,8C111.033,8,0,119.033,0,256S111.033,504,248,504,496,392.967,496,256,384.967,8,248,8ZM362.952,176.66c-3.732,39.215-19.881,134.378-28.1,178.3-3.476,18.584-10.322,24.816-16.948,25.425-14.4,1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25,5.342-39.5,3.652-3.793,67.107-61.51,68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608,69.142-14.845,10.194-26.894,9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7,18.45-13.7,108.446-47.248,144.628-62.3c68.872-28.647,83.183-33.623,92.511-33.789,2.052-.034,6.639.474,9.61,2.885a10.452,10.452,0,0,1,3.53,6.716A43.765,43.765,0,0,1,362.952,176.66Z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/auroraisnear" target="_blank" rel="nofollow noopener noreferrer" class="footer__link-item" title="Aurora on Twitter"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" class="svg-inline--fa fa-twitter fa-lg" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UC5inYyvUO10iL65hBPFtpvg" target="_blank" rel="nofollow noopener noreferrer" class="footer__link-item" title="Aurora on YouTube"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="youtube" class="svg-inline--fa fa-youtube fa-lg" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentColor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"></path></svg></a></li></ul></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2025 Aurora Labs</div></div></div></footer></div>
</body>
</html>